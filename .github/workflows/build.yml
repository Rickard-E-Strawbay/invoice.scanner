name: Build Docker Images

on:
  push:
    branches:
      - re_deploy_start
      - main

env:
  REGISTRY: europe-west1-docker.pkg.dev
  IMAGE_PREFIX: invoice-scanner

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Determine which environment based on branch
      - name: Set environment variables
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "ENVIRONMENT=prod" >> $GITHUB_ENV
            echo "PROJECT_ID=strawbayscannerprod" >> $GITHUB_ENV
          else
            echo "ENVIRONMENT=test" >> $GITHUB_ENV
            echo "PROJECT_ID=strawbayscannertest" >> $GITHUB_ENV
          fi

      # Authenticate to Google Cloud (PROD)
      - name: Authenticate to Google Cloud (PROD)
        if: github.ref == 'refs/heads/main'
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}

      # Authenticate to Google Cloud (TEST)
      - name: Authenticate to Google Cloud (TEST)
        if: github.ref != 'refs/heads/main'
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_TEST }}

      # Setup Google Cloud SDK
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      # Configure Docker for Artifact Registry
      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.REGISTRY }} --quiet

      # Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Build and push API image
      - name: Build and push API image
        run: |
          docker build \
            -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.IMAGE_PREFIX }}/api:latest \
            -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.IMAGE_PREFIX }}/api:${{ github.sha }} \
            invoice.scanner.api/
          
          docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.IMAGE_PREFIX }}/api:latest
          docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.IMAGE_PREFIX }}/api:${{ github.sha }}

      # Build and push Frontend image
      - name: Build and push Frontend image
        run: |
          docker build \
            -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.IMAGE_PREFIX }}/frontend:latest \
            -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.IMAGE_PREFIX }}/frontend:${{ github.sha }} \
            invoice.scanner.frontend.react/
          
          docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.IMAGE_PREFIX }}/frontend:latest
          docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.IMAGE_PREFIX }}/frontend:${{ github.sha }}

      # Build and push Worker image
      - name: Build and push Worker image
        run: |
          docker build \
            -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.IMAGE_PREFIX }}/worker:latest \
            -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.IMAGE_PREFIX }}/worker:${{ github.sha }} \
            invoice.scanner.processing/
          
          docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.IMAGE_PREFIX }}/worker:latest
          docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.IMAGE_PREFIX }}/worker:${{ github.sha }}

      # Output summary
      - name: Summary
        run: |
          echo "âœ… Build completed for ${{ env.ENVIRONMENT }} environment"
          echo ""
          echo "Published images:"
          echo "  - ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.IMAGE_PREFIX }}/api:latest"
          echo "  - ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.IMAGE_PREFIX }}/frontend:latest"
          echo "  - ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.IMAGE_PREFIX }}/worker:latest"
          echo ""
          echo "Also tagged with commit SHA: ${{ github.sha }}"
