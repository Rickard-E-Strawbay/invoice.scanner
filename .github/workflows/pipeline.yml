name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      deploy_cloud_functions:
        description: 'Deploy Cloud Functions?'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  # =====================
  # BUILD TEST
  # =====================
  build-test:
    runs-on: ubuntu-latest
    
    outputs:
      registry: ${{ steps.set-vars.outputs.registry }}
      gcp_project: ${{ steps.set-vars.outputs.gcp_project }}
      deploy_cloud_functions: ${{ steps.check-cf-flag.outputs.deploy_cf }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for [deploy-cf] flag in commit message
        id: check-cf-flag
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          if [[ "$COMMIT_MSG" == *"[deploy-cf]"* ]]; then
            echo "deploy_cf=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Found [deploy-cf] flag - Cloud Functions will be deployed"
          else
            echo "deploy_cf=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è  No [deploy-cf] flag - skipping Cloud Functions deployment"
          fi

      - name: Set environment variables for TEST
        id: set-vars
        run: |
          echo "gcp_project=strawbayscannertest" >> $GITHUB_OUTPUT
          echo "environment=test" >> $GITHUB_OUTPUT
          echo "registry=europe-west1-docker.pkg.dev/strawbayscannertest/invoice-scanner" >> $GITHUB_OUTPUT

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_TEST }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: Configure Docker authentication
        run: |
          gcloud auth configure-docker europe-west1-docker.pkg.dev

      - name: Build and Push API image
        run: |
          docker build -t ${{ steps.set-vars.outputs.registry }}/api:latest \
                       -t ${{ steps.set-vars.outputs.registry }}/api:${{ github.sha }} \
                       ./invoice.scanner.api
          docker push ${{ steps.set-vars.outputs.registry }}/api:latest
          docker push ${{ steps.set-vars.outputs.registry }}/api:${{ github.sha }}

      - name: Build and Push Frontend image
        run: |
          docker build -t ${{ steps.set-vars.outputs.registry }}/frontend:latest \
                       -t ${{ steps.set-vars.outputs.registry }}/frontend:${{ github.sha }} \
                       ./invoice.scanner.frontend.react
          docker push ${{ steps.set-vars.outputs.registry }}/frontend:latest
          docker push ${{ steps.set-vars.outputs.registry }}/frontend:${{ github.sha }}

      - name: Build and Push Worker image
        run: |
          docker build -t ${{ steps.set-vars.outputs.registry }}/worker:latest \
                       -t ${{ steps.set-vars.outputs.registry }}/worker:${{ github.sha }} \
                       ./invoice.scanner.worker 2>/dev/null || echo "Worker directory not found, skipping"
          docker push ${{ steps.set-vars.outputs.registry }}/worker:latest 2>/dev/null || echo "Worker image skipped"
          docker push ${{ steps.set-vars.outputs.registry }}/worker:${{ github.sha }} 2>/dev/null || echo "Worker image skipped"

      - name: Build Summary
        run: |
          echo "‚úÖ TEST Build Complete!"
          echo "üì¶ Branch: ${{ github.ref }}"
          echo "üåç Environment: test"
          echo "üìç Registry: ${{ steps.set-vars.outputs.registry }}"
          echo "üè∑Ô∏è  SHA: ${{ github.sha }}"

  # =====================
  # DEPLOY CLOUD FUNCTIONS TO TEST (Triggered by [deploy-cf] in commit message)
  # =====================
  deploy-cloud-functions-test:
    needs: build-test
    if: needs.build-test.outputs.deploy_cloud_functions == 'true'
    runs-on: ubuntu-latest
    environment: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_TEST }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: Deploy Cloud Functions to TEST
        run: |
          cd invoice.scanner.cloud.functions
          chmod +x deploy.sh
          ./deploy.sh strawbayscannertest europe-west1

      - name: Verify Cloud Functions Deployment
        run: |
          echo "‚úÖ Cloud Functions Deploy Complete!"
          echo ""
          echo "üìç Project: strawbayscannertest"
          echo "üåç Region:  europe-west1"
          echo ""
          echo "Deployed functions:"
          gcloud functions list --v2 --project=strawbayscannertest --format='table(name,status)'

  # =====================
  # DEPLOY TO TEST (API + Frontend)
  # =====================
  deploy-test:
    needs: build-test
    runs-on: ubuntu-latest
    environment: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_TEST }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: Fetch secrets from GCP Secret Manager
        run: |
          echo "DB_PASSWORD=$(gcloud secrets versions access latest --secret=db_password_test --project=strawbayscannertest)" >> $GITHUB_ENV
          echo "SECRET_KEY=$(gcloud secrets versions access latest --secret=secret_key_test --project=strawbayscannertest)" >> $GITHUB_ENV
          echo "GMAIL_SENDER=$(gcloud secrets versions access latest --secret=gmail_sender --project=strawbayscannertest)" >> $GITHUB_ENV
          echo "GMAIL_PASSWORD=$(gcloud secrets versions access latest --secret=gmail_password --project=strawbayscannertest)" >> $GITHUB_ENV
          echo "OPENAI_API_KEY=$(gcloud secrets versions access latest --secret=openai_api_key --project=strawbayscannertest)" >> $GITHUB_ENV

      - name: Deploy API to Cloud Run
        run: |
          gcloud run deploy invoice-scanner-api-test \
            --image=europe-west1-docker.pkg.dev/strawbayscannertest/invoice-scanner/api:latest \
            --platform=managed \
            --region=europe-west1 \
            --project=strawbayscannertest \
            --allow-unauthenticated \
            --memory=512Mi \
            --cpu=1 \
            --timeout=1800 \
            --max-instances=10 \
            --set-env-vars "INSTANCE_CONNECTION_NAME=strawbayscannertest:europe-west1:invoice-scanner-test,DATABASE_NAME=invoice_scanner,DATABASE_USER=scanner_test,DATABASE_PASSWORD=$DB_PASSWORD,FLASK_SECRET_KEY=$SECRET_KEY,FLASK_ENV=test,EMAIL_SENDER=$GMAIL_SENDER,EMAIL_PASSWORD=$GMAIL_PASSWORD,OPENAI_API_KEY=$OPENAI_API_KEY,GCP_PROJECT=strawbayscannertest,GCP_PROJECT_ID=strawbayscannertest,GCP_REGION=europe-west1,STORAGE_TYPE=gcs,GCS_BUCKET=invoice-scanner-test-docs,PROCESSING_BACKEND=cloud_functions" \
            --service-account=447531332666-compute@developer.gserviceaccount.com
        env:
          DB_PASSWORD: ${{ env.DB_PASSWORD }}
          SECRET_KEY: ${{ env.SECRET_KEY }}
          GMAIL_SENDER: ${{ env.GMAIL_SENDER }}
          GMAIL_PASSWORD: ${{ env.GMAIL_PASSWORD }}
          OPENAI_API_KEY: ${{ env.OPENAI_API_KEY }}

      - name: Grant public access to API
        run: |
          gcloud run services add-iam-policy-binding invoice-scanner-api-test \
            --region=europe-west1 \
            --project=strawbayscannertest \
            --member=allUsers \
            --role=roles/run.invoker

      - name: Deploy Frontend to Cloud Run
        run: |
          gcloud run deploy invoice-scanner-frontend-test \
            --image=europe-west1-docker.pkg.dev/strawbayscannertest/invoice-scanner/frontend:latest \
            --platform=managed \
            --region=europe-west1 \
            --project=strawbayscannertest \
            --allow-unauthenticated \
            --memory=256Mi \
            --cpu=1 \
            --timeout=3600 \
            --max-instances=10 \
            --set-env-vars "ENVIRONMENT=test"

      - name: Grant public access to Frontend
        run: |
          gcloud run services add-iam-policy-binding invoice-scanner-frontend-test \
            --region=europe-west1 \
            --project=strawbayscannertest \
            --member=allUsers \
            --role=roles/run.invoker

      - name: Get service URLs
        run: |
          API_URL=$(gcloud run services describe invoice-scanner-api-test \
            --platform=managed \
            --region=europe-west1 \
            --project=strawbayscannertest \
            --format='value(status.url)')
          
          FRONTEND_URL=$(gcloud run services describe invoice-scanner-frontend-test \
            --platform=managed \
            --region=europe-west1 \
            --project=strawbayscannertest \
            --format='value(status.url)')
          
          echo "API_URL=$API_URL" >> $GITHUB_ENV
          echo "FRONTEND_URL=$FRONTEND_URL" >> $GITHUB_ENV

      - name: Run smoke tests
        run: |
          echo "Testing API health endpoint..."
          API_HEALTH=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.API_URL }}/health || echo "000")
          
          if [ "$API_HEALTH" == "200" ]; then
            echo "‚úÖ API health check passed (HTTP $API_HEALTH)"
          else
            echo "‚ö†Ô∏è  API health check returned (HTTP $API_HEALTH) - may still be initializing"
          fi
          
          echo ""
          echo "Testing Frontend..."
          FRONTEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.FRONTEND_URL }} || echo "000")
          
          if [ "$FRONTEND_STATUS" == "200" ]; then
            echo "‚úÖ Frontend is responding (HTTP $FRONTEND_STATUS)"
          else
            echo "‚ö†Ô∏è  Frontend check returned (HTTP $FRONTEND_STATUS) - may still be initializing"
          fi

      - name: Deployment Summary
        run: |
          echo "‚úÖ TEST Deployment Complete!"
          echo ""
          echo "üåê Service URLs:"
          echo "  API:      ${{ env.API_URL }}"
          echo "  Frontend: ${{ env.FRONTEND_URL }}"
          echo ""
          echo "üìä Environment: TEST"
          echo "üè¢ Project:     strawbayscannertest"
          echo "üåç Region:      europe-west1"

  # =====================
  # APPROVAL GATE (Manual approval before PROD deployment)
  # =====================
  approval-gate:
    needs: deploy-test
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Awaiting Manual Approval
        run: |
          echo "‚è∏Ô∏è  Waiting for manual approval to proceed with PRODUCTION deployment..."
          echo ""
          echo "Review completed TEST deployment before approving."
          echo "Approval required in: GitHub Settings ‚Üí Environments ‚Üí production"

  # =====================
  # BUILD PROD
  # =====================
  build-prod:
    needs: approval-gate
    runs-on: ubuntu-latest
    
    outputs:
      registry: ${{ steps.set-vars.outputs.registry }}
      gcp_project: ${{ steps.set-vars.outputs.gcp_project }}
      deploy_cloud_functions: ${{ steps.check-cf-flag.outputs.deploy_cf }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for [deploy-cf] flag in commit message
        id: check-cf-flag
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          if [[ "$COMMIT_MSG" == *"[deploy-cf]"* ]]; then
            echo "deploy_cf=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Found [deploy-cf] flag - Cloud Functions will be deployed"
          else
            echo "deploy_cf=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è  No [deploy-cf] flag - skipping Cloud Functions deployment"
          fi

      - name: Set environment variables for PROD
        id: set-vars
        run: |
          echo "gcp_project=strawbayscannerprod" >> $GITHUB_OUTPUT
          echo "environment=prod" >> $GITHUB_OUTPUT
          echo "registry=europe-west1-docker.pkg.dev/strawbayscannerprod/invoice-scanner" >> $GITHUB_OUTPUT

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: Configure Docker authentication
        run: |
          gcloud auth configure-docker europe-west1-docker.pkg.dev

      - name: Build and Push API image
        run: |
          docker build -t ${{ steps.set-vars.outputs.registry }}/api:latest \
                       -t ${{ steps.set-vars.outputs.registry }}/api:${{ github.sha }} \
                       ./invoice.scanner.api
          docker push ${{ steps.set-vars.outputs.registry }}/api:latest
          docker push ${{ steps.set-vars.outputs.registry }}/api:${{ github.sha }}

      - name: Build and Push Frontend image
        run: |
          docker build -t ${{ steps.set-vars.outputs.registry }}/frontend:latest \
                       -t ${{ steps.set-vars.outputs.registry }}/frontend:${{ github.sha }} \
                       ./invoice.scanner.frontend.react
          docker push ${{ steps.set-vars.outputs.registry }}/frontend:latest
          docker push ${{ steps.set-vars.outputs.registry }}/frontend:${{ github.sha }}

      - name: Build and Push Worker image
        run: |
          docker build -t ${{ steps.set-vars.outputs.registry }}/worker:latest \
                       -t ${{ steps.set-vars.outputs.registry }}/worker:${{ github.sha }} \
                       ./invoice.scanner.worker 2>/dev/null || echo "Worker directory not found, skipping"
          docker push ${{ steps.set-vars.outputs.registry }}/worker:latest 2>/dev/null || echo "Worker image skipped"
          docker push ${{ steps.set-vars.outputs.registry }}/worker:${{ github.sha }} 2>/dev/null || echo "Worker image skipped"

      - name: Build Summary
        run: |
          echo "‚úÖ PROD Build Complete!"
          echo "üì¶ Branch: ${{ github.ref }}"
          echo "üåç Environment: prod"
          echo "üìç Registry: ${{ steps.set-vars.outputs.registry }}"
          echo "üè∑Ô∏è  SHA: ${{ github.sha }}"

  # =====================
  # DEPLOY CLOUD FUNCTIONS TO PROD (Triggered by [deploy-cf] in commit message)
  # =====================
  deploy-cloud-functions-prod:
    needs: build-prod
    if: needs.build-prod.outputs.deploy_cloud_functions == 'true'
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: Deploy Cloud Functions to PROD
        run: |
          cd invoice.scanner.cloud.functions
          chmod +x deploy.sh
          ./deploy.sh strawbayscannerprod europe-west1

      - name: Verify Cloud Functions Deployment
        run: |
          echo "‚úÖ Cloud Functions Deploy Complete!"
          echo ""
          echo "üìç Project: strawbayscannerprod"
          echo "üåç Region:  europe-west1"
          echo ""
          echo "Deployed functions:"
          gcloud functions list --v2 --project=strawbayscannerprod --format='table(name,status)'

  # =====================
  # DEPLOY TO PROD (API + Frontend)
  # =====================
  deploy-prod:
    needs: [build-prod]
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: Fetch secrets from GCP Secret Manager
        run: |
          echo "DB_PASSWORD=$(gcloud secrets versions access latest --secret=db_password_prod --project=strawbayscannerprod)" >> $GITHUB_ENV
          echo "SECRET_KEY=$(gcloud secrets versions access latest --secret=secret_key_prod --project=strawbayscannerprod)" >> $GITHUB_ENV
          echo "GMAIL_SENDER=$(gcloud secrets versions access latest --secret=gmail_sender --project=strawbayscannerprod)" >> $GITHUB_ENV
          echo "GMAIL_PASSWORD=$(gcloud secrets versions access latest --secret=gmail_password --project=strawbayscannerprod)" >> $GITHUB_ENV
          echo "OPENAI_API_KEY=$(gcloud secrets versions access latest --secret=openai_api_key --project=strawbayscannerprod)" >> $GITHUB_ENV

      - name: Deploy API to Cloud Run
        run: |
          gcloud run deploy invoice-scanner-api-prod \
            --image=europe-west1-docker.pkg.dev/strawbayscannerprod/invoice-scanner/api:latest \
            --platform=managed \
            --region=europe-west1 \
            --project=strawbayscannerprod \
            --allow-unauthenticated \
            --memory=512Mi \
            --cpu=1 \
            --timeout=1800 \
            --max-instances=20 \
            --min-instances=1 \
            --set-env-vars "INSTANCE_CONNECTION_NAME=strawbayscannerprod:europe-west1:invoice-scanner-prod,DATABASE_NAME=invoice_scanner,DATABASE_USER=scanner_prod,DATABASE_PASSWORD=$DB_PASSWORD,FLASK_SECRET_KEY=$SECRET_KEY,FLASK_ENV=production,EMAIL_SENDER=$GMAIL_SENDER,EMAIL_PASSWORD=$GMAIL_PASSWORD,OPENAI_API_KEY=$OPENAI_API_KEY,GCP_PROJECT=strawbayscannerprod,GCP_PROJECT_ID=strawbayscannerprod,GCP_REGION=europe-west1,STORAGE_TYPE=gcs,GCS_BUCKET=invoice-scanner-prod-docs,PROCESSING_BACKEND=cloud_functions" \
            --service-account=527148217996-compute@developer.gserviceaccount.com
        env:
          DB_PASSWORD: ${{ env.DB_PASSWORD }}
          SECRET_KEY: ${{ env.SECRET_KEY }}
          GMAIL_SENDER: ${{ env.GMAIL_SENDER }}
          GMAIL_PASSWORD: ${{ env.GMAIL_PASSWORD }}
          OPENAI_API_KEY: ${{ env.OPENAI_API_KEY }}

      - name: Grant public access to API
        run: |
          gcloud run services add-iam-policy-binding invoice-scanner-api-prod \
            --region=europe-west1 \
            --project=strawbayscannerprod \
            --member=allUsers \
            --role=roles/run.invoker

      - name: Deploy Frontend to Cloud Run
        run: |
          gcloud run deploy invoice-scanner-frontend-prod \
            --image=europe-west1-docker.pkg.dev/strawbayscannerprod/invoice-scanner/frontend:latest \
            --platform=managed \
            --region=europe-west1 \
            --project=strawbayscannerprod \
            --allow-unauthenticated \
            --memory=256Mi \
            --cpu=1 \
            --timeout=3600 \
            --max-instances=20 \
            --min-instances=1 \
            --set-env-vars "ENVIRONMENT=production"

      - name: Grant public access to Frontend
        run: |
          gcloud run services add-iam-policy-binding invoice-scanner-frontend-prod \
            --region=europe-west1 \
            --project=strawbayscannerprod \
            --member=allUsers \
            --role=roles/run.invoker

      - name: Get service URLs
        run: |
          API_URL=$(gcloud run services describe invoice-scanner-api-prod \
            --platform=managed \
            --region=europe-west1 \
            --project=strawbayscannerprod \
            --format='value(status.url)')
          
          FRONTEND_URL=$(gcloud run services describe invoice-scanner-frontend-prod \
            --platform=managed \
            --region=europe-west1 \
            --project=strawbayscannerprod \
            --format='value(status.url)')
          
          echo "API_URL=$API_URL" >> $GITHUB_ENV
          echo "FRONTEND_URL=$FRONTEND_URL" >> $GITHUB_ENV

      - name: Run smoke tests
        run: |
          echo "Testing API health endpoint..."
          API_HEALTH=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.API_URL }}/health || echo "000")
          
          if [ "$API_HEALTH" == "200" ]; then
            echo "‚úÖ API health check passed (HTTP $API_HEALTH)"
          else
            echo "‚ö†Ô∏è  API health check returned (HTTP $API_HEALTH) - may still be initializing"
          fi
          
          echo ""
          echo "Testing Frontend..."
          FRONTEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.FRONTEND_URL }} || echo "000")
          
          if [ "$FRONTEND_STATUS" == "200" ]; then
            echo "‚úÖ Frontend is responding (HTTP $FRONTEND_STATUS)"
          else
            echo "‚ö†Ô∏è  Frontend check returned (HTTP $FRONTEND_STATUS) - may still be initializing"
          fi

      - name: Deployment Summary
        run: |
          echo "‚úÖ PROD Deployment Complete!"
          echo ""
          echo "üåê Service URLs:"
          echo "  API:      ${{ env.API_URL }}"
          echo "  Frontend: ${{ env.FRONTEND_URL }}"
          echo ""
          echo "üìä Environment: PRODUCTION"
          echo "üè¢ Project:     strawbayscannerprod"
          echo "üåç Region:      europe-west1"
