name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  # =====================
  # BUILD TEST
  # =====================
  build-test:
    runs-on: ubuntu-latest
    
    outputs:
      registry: ${{ steps.set-vars.outputs.registry }}
      gcp_project: ${{ steps.set-vars.outputs.gcp_project }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set environment variables for TEST
        id: set-vars
        run: |
          echo "gcp_project=strawbayscannertest" >> $GITHUB_OUTPUT
          echo "environment=test" >> $GITHUB_OUTPUT
          echo "registry=europe-west1-docker.pkg.dev/strawbayscannertest/invoice-scanner" >> $GITHUB_OUTPUT

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_TEST }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: Configure Docker authentication
        run: |
          gcloud auth configure-docker europe-west1-docker.pkg.dev

      - name: Build and Push API image
        run: |
          docker build -t ${{ steps.set-vars.outputs.registry }}/api:latest \
                       -t ${{ steps.set-vars.outputs.registry }}/api:${{ github.sha }} \
                       -f invoice.scanner.api/Dockerfile .
          docker push ${{ steps.set-vars.outputs.registry }}/api:latest
          docker push ${{ steps.set-vars.outputs.registry }}/api:${{ github.sha }}

      - name: Build and Push Frontend image
        run: |
          docker build -t ${{ steps.set-vars.outputs.registry }}/frontend:latest \
                       -t ${{ steps.set-vars.outputs.registry }}/frontend:${{ github.sha }} \
                       ./invoice.scanner.frontend.react
          docker push ${{ steps.set-vars.outputs.registry }}/frontend:latest
          docker push ${{ steps.set-vars.outputs.registry }}/frontend:${{ github.sha }}

      - name: Build and Push Processing image
        run: |
          docker build -t ${{ steps.set-vars.outputs.registry }}/processing:latest \
                       -t ${{ steps.set-vars.outputs.registry }}/processing:${{ github.sha }} \
                       -f invoice.scanner.processing/Dockerfile .
          docker push ${{ steps.set-vars.outputs.registry }}/processing:latest
          docker push ${{ steps.set-vars.outputs.registry }}/processing:${{ github.sha }}

      - name: Build Summary
        run: |
          echo "‚úÖ TEST Build Complete!"
          echo "üì¶ Branch: ${{ github.ref }}"
          echo "üåç Environment: test"
          echo "üìç Registry: ${{ steps.set-vars.outputs.registry }}"
          echo "üè∑Ô∏è  SHA: ${{ github.sha }}"

  # =====================
  # DEPLOY TO TEST (API + Frontend)
  # =====================
  deploy-test:
    needs: build-test
    runs-on: ubuntu-latest
    environment: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_TEST }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: Fetch secrets from GCP Secret Manager
        run: |
          DB_PASSWORD=$(gcloud secrets versions access latest --secret=db_password_test --project=strawbayscannertest 2>/dev/null || echo "")
          echo "DB_PASSWORD=$DB_PASSWORD" >> $GITHUB_ENV
          
          SECRET_KEY=$(gcloud secrets versions access latest --secret=secret_key_test --project=strawbayscannertest 2>/dev/null || echo "dev-secret-key")
          echo "SECRET_KEY=$SECRET_KEY" >> $GITHUB_ENV
          
          SENDGRID_API_KEY=$(gcloud secrets versions access latest --secret=sendgrid_api_key_test --project=strawbayscannertest 2>/dev/null || echo "")
          echo "SENDGRID_API_KEY=$SENDGRID_API_KEY" >> $GITHUB_ENV
          
          OPENAI_API_KEY=$(gcloud secrets versions access latest --secret=openai_api_key --project=strawbayscannertest 2>/dev/null || echo "")
          echo "OPENAI_API_KEY=$OPENAI_API_KEY" >> $GITHUB_ENV
          
          echo "‚úì Secrets loaded (some may be empty if permissions denied)"

      - name: Deploy API to Cloud Run
        run: |
          gcloud run deploy invoice-scanner-api-test \
            --image=europe-west1-docker.pkg.dev/strawbayscannertest/invoice-scanner/api:latest \
            --platform=managed \
            --region=europe-west1 \
            --project=strawbayscannertest \
            --allow-unauthenticated \
            --memory=512Mi \
            --cpu=1 \
            --timeout=1800 \
            --max-instances=10 \
            --set-env-vars "INSTANCE_CONNECTION_NAME=strawbayscannertest:europe-west1:invoice-scanner-test,DATABASE_NAME=invoice_scanner,DATABASE_USER=scanner_test,DATABASE_PASSWORD=$DB_PASSWORD,FLASK_SECRET_KEY=$SECRET_KEY,FLASK_ENV=test,ENVIRONMENT=test,SENDGRID_API_KEY=$SENDGRID_API_KEY,SENDGRID_FROM_EMAIL=noreply@strawbay.io,OPENAI_API_KEY=$OPENAI_API_KEY,GCP_PROJECT=strawbayscannertest,GCP_PROJECT_ID=strawbayscannertest,GCP_REGION=europe-west1,STORAGE_TYPE=gcs,GCS_BUCKET=invoice-scanner-test-docs,PROCESSING_BACKEND=worker_service,CORS_ORIGINS=*.run.app" \
            --service-account=447531332666-compute@developer.gserviceaccount.com
        env:
          DB_PASSWORD: ${{ env.DB_PASSWORD }}
          SECRET_KEY: ${{ env.SECRET_KEY }}
          SENDGRID_API_KEY: ${{ env.SENDGRID_API_KEY }}
          OPENAI_API_KEY: ${{ env.OPENAI_API_KEY }}
        id: deploy_api_test

      - name: Grant public access to API
        run: |
          gcloud run services add-iam-policy-binding invoice-scanner-api-test \
            --region=europe-west1 \
            --project=strawbayscannertest \
            --member=allUsers \
            --role=roles/run.invoker

      - name: Deploy Frontend to Cloud Run
        run: |
          gcloud run deploy invoice-scanner-frontend-test \
            --image=europe-west1-docker.pkg.dev/strawbayscannertest/invoice-scanner/frontend:latest \
            --platform=managed \
            --region=europe-west1 \
            --project=strawbayscannertest \
            --allow-unauthenticated \
            --memory=256Mi \
            --cpu=1 \
            --timeout=3600 \
            --max-instances=10 \
            --set-env-vars "ENVIRONMENT=test,VITE_API_URL=${{ env.API_URL }}" 
        id: deploy_frontend_test

      - name: Deploy Processing Service to Cloud Run
        run: |
          gcloud run deploy invoice-scanner-processing-test \
            --image=europe-west1-docker.pkg.dev/strawbayscannertest/invoice-scanner/processing:latest \
            --platform=managed \
            --region=europe-west1 \
            --project=strawbayscannertest \
            --allow-unauthenticated \
            --memory=1Gi \
            --cpu=2 \
            --timeout=3600 \
            --max-instances=5 \
            --set-env-vars "PYTHONUNBUFFERED=1,FLASK_APP=main:app,INSTANCE_CONNECTION_NAME=strawbayscannertest:europe-west1:invoice-scanner-test,DATABASE_USER=scanner_test,DATABASE_PASSWORD=$DB_PASSWORD,DATABASE_NAME=invoice_scanner,ENVIRONMENT=test,PROCESSING_MODE=cloud_run" \
            --service-account=447531332666-compute@developer.gserviceaccount.com
        env:
          DB_PASSWORD: ${{ env.DB_PASSWORD }}
        id: deploy_processing_test
      
      - name: Get Processing Service URL
        run: |
          PROCESSING_URL=$(gcloud run services describe invoice-scanner-processing-test \
            --platform=managed \
            --region=europe-west1 \
            --project=strawbayscannertest \
            --format='value(status.url)')
          echo "PROCESSING_URL=$PROCESSING_URL" >> $GITHUB_ENV

      - name: Grant public access to Frontend
        run: |
          gcloud run services add-iam-policy-binding invoice-scanner-frontend-test \
            --region=europe-west1 \
            --project=strawbayscannertest \
            --member=allUsers \
            --role=roles/run.invoker

      - name: Get API URL
        run: |
          API_URL=$(gcloud run services describe invoice-scanner-api-test \
            --platform=managed \
            --region=europe-west1 \
            --project=strawbayscannertest \
            --format='value(status.url)')
          echo "API_URL=$API_URL" >> $GITHUB_ENV
        id: get_api_url
      
      - name: Update API with Processing URL
        run: |
          gcloud run deploy invoice-scanner-api-test \
            --image=europe-west1-docker.pkg.dev/strawbayscannertest/invoice-scanner/api:latest \
            --platform=managed \
            --region=europe-west1 \
            --project=strawbayscannertest \
            --update-env-vars "PROCESSING_SERVICE_URL=${{ env.PROCESSING_URL }}" \
            --service-account=447531332666-compute@developer.gserviceaccount.com

      - name: Run smoke tests
        run: |
          echo "Testing API health endpoint..."
          API_HEALTH=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.API_URL }}/health || echo "000")
          
          if [ "$API_HEALTH" == "200" ]; then
            echo "‚úÖ API health check passed (HTTP $API_HEALTH)"
          else
            echo "‚ö†Ô∏è  API health check returned (HTTP $API_HEALTH) - may still be initializing"
          fi
          
          echo ""
          echo "Testing Frontend..."
          FRONTEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.FRONTEND_URL }} || echo "000")
          
          if [ "$FRONTEND_STATUS" == "200" ]; then
            echo "‚úÖ Frontend is responding (HTTP $FRONTEND_STATUS)"
          else
            echo "‚ö†Ô∏è  Frontend check returned (HTTP $FRONTEND_STATUS) - may still be initializing"
          fi
          
          echo ""
          echo "Testing Processing Service..."
          PROCESSING_STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.PROCESSING_URL }}/health 2>/dev/null || echo "000")
          
          if [ "$PROCESSING_STATUS" == "200" ]; then
            echo "‚úÖ Processing service health check passed (HTTP $PROCESSING_STATUS)"
          else
            echo "‚ö†Ô∏è  Processing service check returned (HTTP $PROCESSING_STATUS) - may still be initializing"
          fi

      - name: Deployment Summary
        run: |
          echo "‚úÖ TEST Deployment Complete!"
          echo ""
          echo "üåê Service URLs:"
          echo "  API:        ${{ env.API_URL }}"
          echo "  Frontend:   ${{ env.FRONTEND_URL }}"
          echo "  Processing: ${{ env.PROCESSING_URL }}"
          echo ""
          echo "üìä Environment: TEST"
          echo "üè¢ Project:     strawbayscannertest"
          echo "üåç Region:      europe-west1"

  # =====================
  # APPROVAL GATE (Manual approval before PROD deployment)
  # =====================
  approval-gate:
    needs: deploy-test
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Awaiting Manual Approval
        run: |
          echo "‚è∏Ô∏è  Waiting for manual approval to proceed with PRODUCTION deployment..."
          echo ""
          echo "Review completed TEST deployment before approving."
          echo "Approval required in: GitHub Settings ‚Üí Environments ‚Üí production"

  # =====================
  # BUILD PROD
  # =====================
  build-prod:
    needs: approval-gate
    runs-on: ubuntu-latest
    
    outputs:
      registry: ${{ steps.set-vars.outputs.registry }}
      gcp_project: ${{ steps.set-vars.outputs.gcp_project }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set environment variables for PROD
        id: set-vars
        run: |
          echo "gcp_project=strawbayscannerprod" >> $GITHUB_OUTPUT
          echo "environment=prod" >> $GITHUB_OUTPUT
          echo "registry=europe-west1-docker.pkg.dev/strawbayscannerprod/invoice-scanner" >> $GITHUB_OUTPUT

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: Configure Docker authentication
        run: |
          gcloud auth configure-docker europe-west1-docker.pkg.dev

      - name: Build and Push API image
        run: |
          docker build -t ${{ steps.set-vars.outputs.registry }}/api:latest \
                       -t ${{ steps.set-vars.outputs.registry }}/api:${{ github.sha }} \
                       -f invoice.scanner.api/Dockerfile .
          docker push ${{ steps.set-vars.outputs.registry }}/api:latest
          docker push ${{ steps.set-vars.outputs.registry }}/api:${{ github.sha }}

      - name: Build and Push Frontend image
        run: |
          docker build -t ${{ steps.set-vars.outputs.registry }}/frontend:latest \
                       -t ${{ steps.set-vars.outputs.registry }}/frontend:${{ github.sha }} \
                       ./invoice.scanner.frontend.react
          docker push ${{ steps.set-vars.outputs.registry }}/frontend:latest
          docker push ${{ steps.set-vars.outputs.registry }}/frontend:${{ github.sha }}

      - name: Build and Push Processing image
        run: |
          docker build -t ${{ steps.set-vars.outputs.registry }}/processing:latest \
                       -t ${{ steps.set-vars.outputs.registry }}/processing:${{ github.sha }} \
                       -f invoice.scanner.processing/Dockerfile .
          docker push ${{ steps.set-vars.outputs.registry }}/processing:latest
          docker push ${{ steps.set-vars.outputs.registry }}/processing:${{ github.sha }}

      - name: Build Summary
        run: |
          echo "‚úÖ PROD Build Complete!"
          echo "üì¶ Branch: ${{ github.ref }}"
          echo "üåç Environment: prod"
          echo "üìç Registry: ${{ steps.set-vars.outputs.registry }}"
          echo "üè∑Ô∏è  SHA: ${{ github.sha }}"

  # =====================
  # DEPLOY TO PROD (API + Frontend)
  # =====================
  deploy-prod:
    needs: [approval-gate, build-prod]
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: Fetch secrets from GCP Secret Manager
        run: |
          DB_PASSWORD=$(gcloud secrets versions access latest --secret=db_password_prod --project=strawbayscannerprod 2>/dev/null || echo "")
          echo "DB_PASSWORD=$DB_PASSWORD" >> $GITHUB_ENV
          
          SECRET_KEY=$(gcloud secrets versions access latest --secret=secret_key_prod --project=strawbayscannerprod 2>/dev/null || echo "prod-secret-key")
          echo "SECRET_KEY=$SECRET_KEY" >> $GITHUB_ENV
          
          SENDGRID_API_KEY=$(gcloud secrets versions access latest --secret=sendgrid_api_key_prod --project=strawbayscannerprod 2>/dev/null || echo "")
          echo "SENDGRID_API_KEY=$SENDGRID_API_KEY" >> $GITHUB_ENV
          
          OPENAI_API_KEY=$(gcloud secrets versions access latest --secret=openai_api_key --project=strawbayscannerprod 2>/dev/null || echo "")
          echo "OPENAI_API_KEY=$OPENAI_API_KEY" >> $GITHUB_ENV
          
          echo "‚úì Secrets loaded (some may be empty if permissions denied)"

      - name: Deploy API to Cloud Run
        run: |
          gcloud run deploy invoice-scanner-api-prod \
            --image=europe-west1-docker.pkg.dev/strawbayscannerprod/invoice-scanner/api:latest \
            --platform=managed \
            --region=europe-west1 \
            --project=strawbayscannerprod \
            --allow-unauthenticated \
            --memory=512Mi \
            --cpu=1 \
            --timeout=1800 \
            --max-instances=20 \
            --min-instances=1 \
            --set-env-vars "INSTANCE_CONNECTION_NAME=strawbayscannerprod:europe-west1:invoice-scanner-prod,DATABASE_NAME=invoice_scanner,DATABASE_USER=scanner_prod,DATABASE_PASSWORD=$DB_PASSWORD,FLASK_SECRET_KEY=$SECRET_KEY,FLASK_ENV=production,ENVIRONMENT=prod,SENDGRID_API_KEY=$SENDGRID_API_KEY,SENDGRID_FROM_EMAIL=noreply@strawbay.io,OPENAI_API_KEY=$OPENAI_API_KEY,GCP_PROJECT=strawbayscannerprod,GCP_PROJECT_ID=strawbayscannerprod,GCP_REGION=europe-west1,STORAGE_TYPE=gcs,GCS_BUCKET=invoice-scanner-prod-docs,PROCESSING_BACKEND=worker_service,CORS_ORIGINS=*.run.app" \
            --service-account=527148217996-compute@developer.gserviceaccount.com
        env:
          DB_PASSWORD: ${{ env.DB_PASSWORD }}
          SECRET_KEY: ${{ env.SECRET_KEY }}
          SENDGRID_API_KEY: ${{ env.SENDGRID_API_KEY }}
          OPENAI_API_KEY: ${{ env.OPENAI_API_KEY }}
        id: deploy_api_prod

      - name: Grant public access to API
        run: |
          gcloud run services add-iam-policy-binding invoice-scanner-api-prod \
            --region=europe-west1 \
            --project=strawbayscannerprod \
            --member=allUsers \
            --role=roles/run.invoker

      - name: Deploy Frontend to Cloud Run
        run: |
          gcloud run deploy invoice-scanner-frontend-prod \
            --image=europe-west1-docker.pkg.dev/strawbayscannerprod/invoice-scanner/frontend:latest \
            --platform=managed \
            --region=europe-west1 \
            --project=strawbayscannerprod \
            --allow-unauthenticated \
            --memory=256Mi \
            --cpu=1 \
            --timeout=3600 \
            --max-instances=20 \
            --min-instances=1 \
            --set-env-vars "ENVIRONMENT=production,VITE_API_URL=${{ env.API_URL }}"

      - name: Deploy Processing Service to Cloud Run
        run: |
          gcloud run deploy invoice-scanner-processing-prod \
            --image=europe-west1-docker.pkg.dev/strawbayscannerprod/invoice-scanner/processing:latest \
            --platform=managed \
            --region=europe-west1 \
            --project=strawbayscannerprod \
            --allow-unauthenticated \
            --memory=2Gi \
            --cpu=2 \
            --timeout=3600 \
            --max-instances=10 \
            --min-instances=1 \
            --set-env-vars "PYTHONUNBUFFERED=1,FLASK_APP=main:app,INSTANCE_CONNECTION_NAME=strawbayscannerprod:europe-west1:invoice-scanner-prod,DATABASE_USER=scanner_prod,DATABASE_PASSWORD=$DB_PASSWORD,DATABASE_NAME=invoice_scanner,ENVIRONMENT=prod,PROCESSING_MODE=cloud_run" \
            --service-account=527148217996-compute@developer.gserviceaccount.com
        env:
          DB_PASSWORD: ${{ env.DB_PASSWORD }}
        id: deploy_processing_prod
      
      - name: Get Processing URL (PROD)
        run: |
          PROCESSING_URL=$(gcloud run services describe invoice-scanner-processing-prod \
            --platform=managed \
            --region=europe-west1 \
            --project=strawbayscannerprod \
            --format='value(status.url)')
          echo "PROCESSING_URL=$PROCESSING_URL" >> $GITHUB_ENV

      - name: Grant public access to Frontend
        run: |
          gcloud run services add-iam-policy-binding invoice-scanner-frontend-prod \
            --region=europe-west1 \
            --project=strawbayscannerprod \
            --member=allUsers \
            --role=roles/run.invoker

      - name: Get API URL (PROD)
        run: |
          API_URL=$(gcloud run services describe invoice-scanner-api-prod \
            --platform=managed \
            --region=europe-west1 \
            --project=strawbayscannerprod \
            --format='value(status.url)')
          echo "API_URL=$API_URL" >> $GITHUB_ENV
        id: get_api_url_prod
      
      - name: Update API with Processing URL (PROD)
        run: |
          gcloud run deploy invoice-scanner-api-prod \
            --image=europe-west1-docker.pkg.dev/strawbayscannerprod/invoice-scanner/api:latest \
            --platform=managed \
            --region=europe-west1 \
            --project=strawbayscannerprod \
            --update-env-vars "PROCESSING_SERVICE_URL=${{ env.PROCESSING_URL }}" \
            --service-account=527148217996-compute@developer.gserviceaccount.com

      - name: Run smoke tests
        run: |
          echo "Testing API health endpoint..."
          API_HEALTH=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.API_URL }}/health || echo "000")
          
          if [ "$API_HEALTH" == "200" ]; then
            echo "‚úÖ API health check passed (HTTP $API_HEALTH)"
          else
            echo "‚ö†Ô∏è  API health check returned (HTTP $API_HEALTH) - may still be initializing"
          fi
          
          echo ""
          echo "Testing Frontend..."
          FRONTEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.FRONTEND_URL }} || echo "000")
          
          if [ "$FRONTEND_STATUS" == "200" ]; then
            echo "‚úÖ Frontend is responding (HTTP $FRONTEND_STATUS)"
          else
            echo "‚ö†Ô∏è  Frontend check returned (HTTP $FRONTEND_STATUS) - may still be initializing"
          fi
          
          echo ""
          echo "Testing Processing Service..."
          PROCESSING_STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.PROCESSING_URL }}/health 2>/dev/null || echo "000")
          
          if [ "$PROCESSING_STATUS" == "200" ]; then
            echo "‚úÖ Processing service health check passed (HTTP $PROCESSING_STATUS)"
          else
            echo "‚ö†Ô∏è  Processing service check returned (HTTP $PROCESSING_STATUS) - may still be initializing"
          fi

      - name: Deployment Summary
        run: |
          echo "‚úÖ PROD Deployment Complete!"
          echo ""
          echo "üåê Service URLs:"
          echo "  API:        ${{ env.API_URL }}"
          echo "  Frontend:   ${{ env.FRONTEND_URL }}"
          echo "  Processing: ${{ env.PROCESSING_URL }}"
          echo ""
          echo "üìä Environment: PRODUCTION"
          echo "üè¢ Project:     strawbayscannerprod"
          echo "üåç Region:      europe-west1"
