name: Deploy to PROD

on:
  workflow_run:
    workflows: [Build Docker Images]
    types: [completed]
    branches: [main]

jobs:
  deploy-prod:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://invoice-scanner-api-prod.run.app
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Authenticate to Google Cloud (PROD project)
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}

      # Setup Google Cloud SDK
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      # Fetch secrets from GCP Secret Manager (PROD)
      - name: Fetch secrets from GCP Secret Manager
        run: |
          echo "DB_PASSWORD=$(gcloud secrets versions access latest --secret=db_password_prod --project=strawbayscannerprod)" >> $GITHUB_ENV
          echo "SECRET_KEY=$(gcloud secrets versions access latest --secret=secret_key_prod --project=strawbayscannerprod)" >> $GITHUB_ENV
          echo "GMAIL_SENDER=$(gcloud secrets versions access latest --secret=gmail_sender --project=strawbayscannerprod)" >> $GITHUB_ENV
          echo "GMAIL_PASSWORD=$(gcloud secrets versions access latest --secret=gmail_password --project=strawbayscannerprod)" >> $GITHUB_ENV
          echo "OPENAI_API_KEY=$(gcloud secrets versions access latest --secret=openai_api_key --project=strawbayscannerprod)" >> $GITHUB_ENV

      # Deploy API to Cloud Run (PROD)
      - name: Deploy API to Cloud Run (PROD)
        run: |
          gcloud run deploy invoice-scanner-api-prod \
            --image=europe-west1-docker.pkg.dev/strawbayscannerprod/invoice-scanner/api:latest \
            --platform=managed \
            --region=europe-west1 \
            --project=strawbayscannerprod \
            --allow-unauthenticated \
            --memory=512Mi \
            --cpu=1 \
            --timeout=1800 \
            --max-instances=20 \
            --min-instances=1 \
            --set-env-vars "DATABASE_HOST=invoice-scanner-prod.c.strawbayscannerprod.cloudsql.googleapis.com,DATABASE_NAME=invoice_scanner,DATABASE_USER=scanner_prod,DATABASE_PASSWORD=$DB_PASSWORD,DATABASE_PORT=5432,FLASK_SECRET_KEY=$SECRET_KEY,FLASK_ENV=production,EMAIL_SENDER=$GMAIL_SENDER,EMAIL_PASSWORD=$GMAIL_PASSWORD,OPENAI_API_KEY=$OPENAI_API_KEY,GCP_PROJECT=strawbayscannerprod,GCP_REGION=europe-west1"
        env:
          DB_PASSWORD: ${{ env.DB_PASSWORD }}
          SECRET_KEY: ${{ env.SECRET_KEY }}
          GMAIL_SENDER: ${{ env.GMAIL_SENDER }}
          GMAIL_PASSWORD: ${{ env.GMAIL_PASSWORD }}
          OPENAI_API_KEY: ${{ env.OPENAI_API_KEY }}

      # Deploy Frontend to Cloud Run (PROD)
      - name: Deploy Frontend to Cloud Run (PROD)
        run: |
          gcloud run deploy invoice-scanner-frontend-prod \
            --image=europe-west1-docker.pkg.dev/strawbayscannerprod/invoice-scanner/frontend:latest \
            --platform=managed \
            --region=europe-west1 \
            --project=strawbayscannerprod \
            --allow-unauthenticated \
            --memory=256Mi \
            --cpu=1 \
            --timeout=3600 \
            --max-instances=20 \
            --min-instances=1 \
            --set-env-vars "API_URL=https://invoice-scanner-api-prod.run.app,ENVIRONMENT=production"

      # Get the deployed URLs
      - name: Get service URLs
        run: |
          API_URL=$(gcloud run services describe invoice-scanner-api-prod \
            --platform=managed \
            --region=europe-west1 \
            --project=strawbayscannerprod \
            --format='value(status.url)')
          
          FRONTEND_URL=$(gcloud run services describe invoice-scanner-frontend-prod \
            --platform=managed \
            --region=europe-west1 \
            --project=strawbayscannerprod \
            --format='value(status.url)')
          
          echo "API_URL=$API_URL" >> $GITHUB_ENV
          echo "FRONTEND_URL=$FRONTEND_URL" >> $GITHUB_ENV

      # Run smoke tests
      - name: Run smoke tests
        run: |
          echo "Testing PROD API health endpoint..."
          API_HEALTH=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.API_URL }}/health)
          
          if [ "$API_HEALTH" == "200" ]; then
            echo "‚úÖ API health check passed (HTTP $API_HEALTH)"
          else
            echo "‚ùå API health check failed (HTTP $API_HEALTH)"
            exit 1
          fi
          
          echo ""
          echo "Testing PROD Frontend..."
          FRONTEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.FRONTEND_URL }})
          
          if [ "$FRONTEND_STATUS" == "200" ]; then
            echo "‚úÖ Frontend is responding (HTTP $FRONTEND_STATUS)"
          else
            echo "‚ùå Frontend check failed (HTTP $FRONTEND_STATUS)"
            exit 1
          fi

      # Summary
      - name: Deployment Summary
        run: |
          echo "üéâ PROD Deployment Complete!"
          echo ""
          echo "üåê Service URLs:"
          echo "  API:      ${{ env.API_URL }}"
          echo "  Frontend: ${{ env.FRONTEND_URL }}"
          echo ""
          echo "üìä Environment: PRODUCTION"
          echo "üè¢ Project:     strawbayscannerprod"
          echo "üåç Region:      europe-west1"
          echo ""
          echo "‚ú® Your application is now live in production!"
