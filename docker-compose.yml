# ============================================================
# INVOICE SCANNER - DOCKER COMPOSE CONFIGURATION
# Minimal local stack: API, Frontend, Database
# Processing: Cloud Functions Framework (external)
# ============================================================
# NOTE: Celery and Redis removed - using Cloud Functions instead

version: '3.8'

services:

  # ============================================================
  # INFRASTRUCTURE - PostgreSQL
  # ============================================================

  db:
    image: postgres:16-alpine
    container_name: invoice.scanner.db
    environment:
      POSTGRES_USER: scanner
      POSTGRES_PASSWORD: scanner
      POSTGRES_DB: invoice_scanner
    ports:
      - "5432:5432"
    volumes:
      - invoice_scanner_data:/var/lib/postgresql/data
      - ./invoice.scanner.db/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - invoice.scanner
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U scanner -d invoice_scanner"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================
  # SERVICE 1: API (invoice.scanner.api)
  # Lightweight REST API server
  # ============================================================

  api:
    build:
      context: .
      dockerfile: ./invoice.scanner.api/Dockerfile
    container_name: invoice.scanner.api
    ports:
      - "5001:5000"
    environment:
      - PYTHONUNBUFFERED=1
      - DATABASE_URL=postgresql://scanner:scanner@db:5432/invoice_scanner
      - DATABASE_HOST=db
      - DATABASE_PORT=5432
      - DATABASE_USER=scanner
      - DATABASE_PASSWORD=scanner
      - DATABASE_NAME=invoice_scanner
      - STORAGE_TYPE=local
      - DOCUMENTS_RAW_DIR=/app/documents/raw
      - DOCUMENTS_PROCESSED_DIR=/app/documents/processed
      - FLASK_ENV=development
      - FRONTEND_URL=http://localhost:8080
      # Processing Backend: Cloud Functions Framework (localhost:9000)
      # External to docker-compose (starts separately on host machine)
      - PROCESSING_BACKEND=local
      - PROCESSING_SERVICE_URL=http://host.docker.internal:9000
      # LLM API Keys (from .env or environment)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - ./invoice.scanner.api:/app
      - ./documents:/app/documents
    networks:
      - invoice.scanner
    restart: unless-stopped

  # ============================================================
  # SERVICE 2: FRONTEND (invoice.scanner.frontend.react)
  # React web application
  # ============================================================

  frontend:
    build:
      context: ./invoice.scanner.frontend.react
      dockerfile: Dockerfile.dev
    container_name: invoice.scanner.frontend
    ports:
      - "8080:8080"
    environment:
      - VITE_API_URL=http://localhost:5001
      - VITE_DEV_SERVER_HOST=0.0.0.0
    volumes:
      - ./invoice.scanner.frontend.react:/app
      - /app/node_modules
    depends_on:
      - api
    networks:
      - invoice.scanner
    restart: unless-stopped

networks:
  invoice.scanner:
    driver: bridge

volumes:
  invoice_scanner_data:

# ============================================================
# USAGE
# ============================================================
#
# Start all services:
#   docker-compose up -d
#
# Start Cloud Functions Framework (separate terminal):
#   cd invoice.scanner.cloud.functions && ./local_server.sh
#
# Services and URLs:
#   API:                http://localhost:5001
#   Frontend (Vite):    http://localhost:8080  (hot-reload enabled)
#   PostgreSQL:         localhost:5432
#   Cloud Functions:    http://localhost:9000 (external, from host.docker.internal)
#
# View logs:
#   docker-compose logs -f                    # All services
#   docker-compose logs -f api                # API only
#   docker-compose logs -f db                 # Database
#
# Stop services:
#   docker-compose down                       # Stop all
#   docker-compose down -v                    # Stop + remove volumes
#
# Environment variables (.env file):
#   OPENAI_API_KEY=sk-...
#   GOOGLE_API_KEY=AIza...
#   ANTHROPIC_API_KEY=sk-ant-...
#
# Processing Backend:
#   Local Cloud Functions Framework runs OUTSIDE docker-compose
#   API connects via host.docker.internal:9000
#   This simulates cloud deployment exactly
#
