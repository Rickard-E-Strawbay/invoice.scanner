# ============================================================
# INVOICE SCANNER - DOCKER COMPOSE CONFIGURATION
# Minimal local stack: API, Frontend, Database
# Processing: Cloud Functions Framework (external)
# ============================================================
# NOTE: Celery and Redis removed - using Cloud Functions instead

services:

  # ============================================================
  # INFRASTRUCTURE - PostgreSQL
  # ============================================================

  db:
    image: postgres:16-alpine
    container_name: invoice.scanner.db
    environment:
      POSTGRES_USER: scanner_local
      POSTGRES_PASSWORD: scanner_local
      POSTGRES_DB: invoice_scanner
    ports:
      - "5432:5432"
    volumes:
      - invoice_scanner_data:/var/lib/postgresql/data
      - ./invoice.scanner.shared/database/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql
    networks:
      - invoice.scanner
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U scanner_local -d invoice_scanner"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================
  # SERVICE 1: API (invoice.scanner.api)
  # Lightweight REST API server
  # ============================================================

  api:
    build:
      context: .
      dockerfile: invoice.scanner.api/Dockerfile
    container_name: invoice.scanner.api
    ports:
      - "5001:5000"
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app:/parent
      - DATABASE_URL=postgresql://scanner_local:scanner_local@db:5432/invoice_scanner
      - DATABASE_HOST=db
      - DATABASE_PORT=5432
      - DATABASE_USER=scanner_local
      - DATABASE_PASSWORD=scanner_local
      - DATABASE_NAME=invoice_scanner
      - STORAGE_TYPE=local
      - DOCUMENTS_RAW_DIR=/app/documents/raw
      - DOCUMENTS_PROCESSED_DIR=/app/documents/processed
      - FLASK_ENV=development
      - FRONTEND_URL=http://localhost:8080
      # Processing Backend: Worker Service on port 8000
      - PROCESSING_BACKEND=worker_service
      - PROCESSING_SERVICE_URL=http://processing:8000
      # Email Configuration (LOCAL: Gmail SMTP)
      - ENVIRONMENT=local
      - GMAIL_SENDER=${GMAIL_SENDER:-}
      - GMAIL_PASSWORD=${GMAIL_PASSWORD:-}
      # LLM API Keys (from .env or environment)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
    depends_on:
      db:
        condition: service_healthy
      processing:
        condition: service_started
    volumes:
      - ./invoice.scanner.api:/app
      - ./invoice.scanner.shared:/parent/shared
      - ./documents:/app/documents
    networks:
      - invoice.scanner
    restart: unless-stopped

  # ============================================================
  # SERVICE 2: PROCESSING (invoice.scanner.processing)
  # Pub/Sub-triggered document processing worker
  # ============================================================

  processing:
    build:
      context: ./invoice.scanner.processing
      dockerfile: Dockerfile.dev
    container_name: invoice.scanner.processing
    ports:
      - "8000:8000"
    environment:
      - PYTHONUNBUFFERED=1
      - FLASK_APP=main:app
      - PYTHONPATH=/app:/parent
      - DATABASE_HOST=db
      - DATABASE_PORT=5432
      - DATABASE_USER=scanner_local
      - DATABASE_PASSWORD=scanner_local
      - DATABASE_NAME=invoice_scanner
      - GCP_PROJECT_ID=strawbayscannertest
      - PROCESSING_LOG_LEVEL=INFO
      - WORKER_MAX_PROCESSES=5
      - PROCESSING_SLEEP_TIME=0.1
      - FLASK_ENV=development
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - ./invoice.scanner.processing:/app
      - ./invoice.scanner.shared:/parent/shared
    networks:
      - invoice.scanner
    restart: unless-stopped

  # ============================================================
  # SERVICE 3: FRONTEND (invoice.scanner.frontend.react)
  # React web application
  # ============================================================

  frontend:
    build:
      context: ./invoice.scanner.frontend.react
      dockerfile: Dockerfile.dev
    container_name: invoice.scanner.frontend
    command: npm run dev -- --host 0.0.0.0 --port 8080
    ports:
      - "8080:8080"
      - "5173:5173"
    environment:
      - VITE_API_URL=http://localhost:5001
      - VITE_DEV_SERVER_HOST=0.0.0.0
    volumes:
      - ./invoice.scanner.frontend.react:/app
      - /app/node_modules
    depends_on:
      - api
    networks:
      - invoice.scanner
    restart: unless-stopped

networks:
  invoice.scanner:
    driver: bridge

volumes:
  invoice_scanner_data:

# ============================================================
# USAGE
# ============================================================
#
# Start all services (docker-compose only):
#   docker-compose up -d
#
# Services and URLs:
#   API:              http://localhost:5001
#   Frontend (Vite):  http://localhost:8080  (hot-reload enabled)
#   Processing:       http://localhost:8000
#   PostgreSQL:       localhost:5432
#
# View logs:
#   docker-compose logs -f              # All services
#   docker-compose logs -f api          # API only
#   docker-compose logs -f processing   # Processing worker
#   docker-compose logs -f db           # Database
#
# Stop services:
#   docker-compose down                 # Stop all
#   docker-compose down -v              # Stop + remove volumes
#
# Environment variables (.env file):
#   OPENAI_API_KEY=sk-...
#   GOOGLE_API_KEY=AIza...
#   ANTHROPIC_API_KEY=sk-ant-...
#
# Document Processing Flow:
#   1. Upload document via API (POST /api/documents)
#   2. API queues document to processing service (HTTP: POST /api/documents/{id}/process)
#   3. Processing service processes through 5 stages:
#      - Preprocess (PDFâ†’PNG)
#      - OCR extraction (with ThreadPool for multi-page)
#      - LLM extraction (with ThreadPool for line items)
#      - Data extraction (normalization)
#      - Evaluation (confidence scoring with ThreadPool)
#   4. Updates database at each stage
#   5. Frontend polls status (GET /api/documents/{id}/status)
#
#
